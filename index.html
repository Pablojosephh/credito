<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Financeiro v9.1 – Seguro Garantia</title>

  <!-- PDF.js e Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --danger: #b91c1c;
      --success: #166534;
      --warning: #854d0e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: #111827;
      color: #fff;
      padding: 18px 20px;
      text-align: center;
    }
    header h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }
    header p {
      margin: 0;
      font-size: 13px;
      color: #9ca3af;
    }
    main {
      max-width: 1200px;
      margin: 20px auto;
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    }
    h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    h3 {
      margin: 0 0 6px;
      font-size: 15px;
    }
    .section {
      margin-bottom: 26px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-top: 10px;
    }
    label {
      font-size: 13px;
      color: #374151;
      margin-bottom: 4px;
      display: block;
    }
    select, input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      margin-bottom: 8px;
    }
    textarea { resize: vertical; min-height: 60px; }
    input[type="file"] {
      margin: 6px 0 10px;
      font-size: 13px;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .btn {
      display: inline-block;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      margin-top: 4px;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 260px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: center;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    .tag {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      vertical-align: middle;
    }
    .tag-baixo   { background: #dcfce7; color: var(--success); }
    .tag-moderado{ background: #fef9c3; color: #854d0e; }
    .tag-alto    { background: #fee2e2; color: var(--danger); }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      color: #4b5563;
      margin-right: 4px;
    }
    .checklist-table td:first-child { text-align: left; }
    .check-ok { color: var(--success); font-weight: bold; }
    .check-bad { color: var(--danger); font-weight: bold; }
    .check-pendente { color: var(--muted); font-weight: bold; }
    footer {
      text-align: center;
      padding: 14px;
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>Portal de Análise Técnica – Seguro Garantia</h1>
    <p>v9.1 • Tomador x Grupo, histórico 2022–2025, limites MCMV/Infra/Permutas e aderência Caixa</p>
  </header>

  <main>
    <!-- 0. Identificação do Tomador e Configurações -->
    <section class="section">
      <h2>0. Identificação do Tomador & Configurações</h2>
      <div class="card flex">
        <div class="col">
          <label>Razão Social do Tomador</label>
          <input type="text" id="nomeTomador" placeholder="Ex.: Realmix Engenharia Ltda." />

          <label>CNPJ</label>
          <input type="text" id="cnpjTomador" placeholder="Ex.: 12.345.678/0001-90" />

          <label>Grupo Econômico</label>
          <input type="text" id="grupoEconomico" placeholder="Ex.: Grupo Realmix" />

          <label>Porte (faturamento)</label>
          <input type="text" id="porteTomador" disabled placeholder="Definido automaticamente pela DRE" />

          <label>Faturamento Anual Estimado</label>
          <input type="text" id="faturamentoTomador" disabled placeholder="Lido da DRE, quando disponível" />
        </div>
        <div class="col">
          <label>Setor</label>
          <select id="setor">
            <option value="real">Real Estate</option>
            <option value="mcmv">MCMV</option>
            <option value="infra">Infraestrutura</option>
            <option value="servicos">Serviços</option>
            <option value="industria">Indústria</option>
          </select>

          <label>Modalidade MCMV / Caixa</label>
          <select id="modalidade">
            <option value="sgto">SGTO (Obras)</option>
            <option value="sgpe">SGPE (Empreendimentos)</option>
            <option value="sgtoInfra">SGTO Infraestrutura</option>
            <option value="permutaFisica">Permuta Física</option>
            <option value="permutaFinanceira">Permuta Financeira</option>
          </select>

          <label>Ano de Referência</label>
          <select id="anoRef">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
          </select>
        </div>
      </div>
    </section>

    <!-- 1. Importar Demonstrações (Tomador + Grupo) -->
    <section class="section">
      <h2>1. Importar Demonstrações (Tomador + Grupo)</h2>
      <div class="card">
        <label>Envie os balanços / DRE do grupo (até 30 PDFs)</label>
        <input type="file" id="pdfFiles" accept="application/pdf" multiple />
        <button class="btn btn-primary" onclick="lerMultiplosPDFs()">Importar e Consolidar</button>
        <p class="hint">
          • O <strong>primeiro arquivo</strong> será considerado como <strong>Tomador</strong>.<br>
          • Os demais arquivos compõem o <strong>Grupo Econômico (consolidado gerencial)</strong>, quando houver mais de um CNPJ.<br>
          • Se todos os arquivos forem do mesmo CNPJ, o portal tratará como múltiplos anos do Tomador, sem grupo distinto.
        </p>
        <p id="pdfStatus" class="hint">Nenhum arquivo importado ainda.</p>
        <div id="listaArquivos" class="hint" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- 2. Tomador vs Grupo Econômico -->
    <section class="section">
      <h2>2. Tomador vs Grupo Econômico</h2>
      <div class="card">
        <div class="flex">
          <div class="col">
            <h3>Tomador (Empresa)</h3>
            <table>
              <thead>
                <tr><th>Indicador</th><th>Valor</th></tr>
              </thead>
              <tbody>
                <tr><td>Liquidez Corrente</td><td id="liqTomador">-</td></tr>
                <tr><td>Dívida Líquida / EBITDA</td><td id="divTomador">-</td></tr>
                <tr><td>Margem EBITDA (%)</td><td id="margTomador">-</td></tr>
              </tbody>
            </table>
          </div>
          <div class="col">
            <h3>Grupo Econômico (Consolidado)</h3>
            <table>
              <thead>
                <tr><th>Indicador</th><th>Valor</th></tr>
              </thead>
              <tbody>
                <tr><td>Liquidez Corrente</td><td id="liqGrupo">-</td></tr>
                <tr><td>Dívida Líquida / EBITDA</td><td id="divGrupo">-</td></tr>
                <tr><td>Margem EBITDA (%)</td><td id="margGrupo">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 18px;">
          <canvas id="graficoTomadorGrupo" height="120"></canvas>
        </div>

        <p id="intercompanyInfo" class="hint" style="margin-top:10px;"></p>
        <div id="intercompanyDetalhes" class="hint" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- 3. Cálculo de Limite Necessário -->
    <section class="section">
      <h2>3. Cálculo de Limite Necessário</h2>
      <div class="card flex">
        <div class="col">
          <label title="Opcional: envie o cronograma/custo da obra em PDF para tentativa de leitura automática do custo total. Os valores preenchidos podem ser revisados manualmente.">
            Documento de custos / cronograma (PDF) – opcional
          </label>
          <input type="file" id="pdfCustos" accept="application/pdf" />
          <button class="btn btn-secondary" onclick="lerCustosDocumento()">Ler custos do documento</button>
          <p class="hint">
            A leitura automática é heurística e pode não localizar corretamente em todos os layouts de balanço/cronograma. Sempre revise os valores.
          </p>

          <label title="Custo total da obra vinculada às apólices SGTO/SGPE. O mesmo custo pode ser utilizado para ambas, variando apenas o percentual (15% e 2%).">
            Custo da Obra (MCMV – base para SGTO e SGPE) – R$
          </label>
          <input type="number" id="custoSgto" min="0" step="1000" placeholder="Ex.: 10000000" />

          <label title="Custo total do empreendimento vinculado à apólice SGPE. Se o custo da obra for o mesmo, pode repetir o valor acima.">
            Custo do Empreendimento (SGPE) – R$
          </label>
          <input type="number" id="custoSgpe" min="0" step="1000" placeholder="Ex.: 50000000" />

          <label title="Custo da obra de infraestrutura não incidente. O limite de SGTO Infra corresponde a 130% desse valor.">
            Custo da Obra Não Incidente (SGTO Infra) – R$
          </label>
          <input type="number" id="custoInfra" min="0" step="1000" placeholder="Ex.: 20000000" />
        </div>
        <div class="col">
          <table>
            <thead>
              <tr>
                <th>Modalidade</th>
                <th>Custo Base (R$)</th>
                <th>Fator</th>
                <th>Limite Necessário (R$)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>SGTO</td>
                <td id="baseSgto">-</td>
                <td>15%</td>
                <td id="limSgto">-</td>
              </tr>
              <tr>
                <td>SGPE</td>
                <td id="baseSgpe">-</td>
                <td>2%</td>
                <td id="limSgpe">-</td>
              </tr>
              <tr>
                <td>SGTO Infra</td>
                <td id="baseInfra">-</td>
                <td>130%</td>
                <td id="limInfra">-</td>
              </tr>
              <tr>
                <td>Permuta Física</td>
                <td id="basePermutaFisica">-</td>
                <td id="fatorPermutaFisica">-</td>
                <td id="limPermutaFisica">-</td>
              </tr>
              <tr>
                <td>Permuta Financeira</td>
                <td id="basePermutaFin">-</td>
                <td>100%</td>
                <td id="limPermutaFin">-</td>
              </tr>
              <tr>
                <th colspan="3">Total de Limite Necessário</th>
                <th id="limTotal">-</th>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 4. Parecer Automático & Capacidade de Emissão -->
    <section class="section">
      <h2>4. Parecer Automático & Capacidade de Emissão</h2>
      <div class="card flex">
        <div class="col" id="parecerAuto">
          Importe os PDFs e informe os custos das obras para gerar a nota de risco, classificação e capacidade de emissão.
        </div>
        <div class="col" id="capacidadeBox">
          <h3>Capacidade de Emissão Estimada</h3>
          <p><strong>Status:</strong> —</p>
          <p><strong>Faixa sugerida (R$):</strong> —</p>
          <p><strong>Nível de taxa sugerida:</strong> —</p>
          <p id="capacidadeObs" class="hint"></p>
        </div>
      </div>
    </section>

    <!-- 5. Histórico do Tomador 2022–2025 -->
    <section class="section">
      <h2>5. Histórico do Tomador (2022–2025)</h2>
      <div class="card">
        <p class="hint">
          Opcional: importe os balanços do Tomador por ano para acompanhar a evolução de crédito no tempo.
          Se os campos de identificação ainda estiverem vazios, o portal tentará preenchê-los a partir do primeiro PDF histórico.
        </p>
        <div class="flex">
          <div class="col">
            <label>Tomador 2022 (PDF)</label>
            <input type="file" id="pdfTomador2022" accept="application/pdf" />
          </div>
          <div class="col">
            <label>Tomador 2023 (PDF)</label>
            <input type="file" id="pdfTomador2023" accept="application/pdf" />
          </div>
          <div class="col">
            <label>Tomador 2024 (PDF)</label>
            <input type="file" id="pdfTomador2024" accept="application/pdf" />
          </div>
          <div class="col">
            <label>Tomador 2025 (PDF)</label>
            <input type="file" id="pdfTomador2025" accept="application/pdf" />
          </div>
        </div>
        <button class="btn btn-secondary" onclick="lerHistoricoTomador()">Importar Histórico</button>

        <div style="margin-top:18px;">
          <canvas id="graficoHistorico" height="120"></canvas>
        </div>
        <div id="resumoHistorico" class="hint" style="margin-top:10px;">
          Ainda não há histórico carregado. Importe pelo menos um ano para visualizar a evolução.
        </div>
      </div>
    </section>

    <!-- 6. Permuta -->
    <section class="section" id="permutaSection" style="display:none;">
      <h2>6. Permuta – Estrutura do Pagamento</h2>
      <div class="card flex">
        <div class="col">
          <label>Tipo de Permuta</label>
          <select id="tipoPermuta">
            <option value="fisica">Física</option>
            <option value="financeira">Financeira</option>
            <option value="mista">Mista</option>
          </select>

          <label>VGV do Empreendimento (R$)</label>
          <input type="number" id="vgvPermuta" min="0" step="1000" />

          <label>Percentual da Permuta sobre VGV (%)</label>
          <input type="number" id="percPermuta" min="0" max="100" step="0.1" />

          <label>Valor da Permuta Financeira (R$)</label>
          <input type="number" id="valorPermutaFin" min="0" step="1000" />
        </div>
        <div class="col" id="permutaAlerta">
          <p class="hint">
            Preencha os dados de permuta para que o portal emita alertas de exposição de liquidez e prazos e atualize o cálculo do limite necessário.
          </p>
        </div>
      </div>
    </section>

    <!-- 7. Aderência Caixa -->
    <section class="section">
      <h2>7. Aderência Caixa Econômica Federal</h2>
      <div class="card">
        <div class="flex">
          <div class="col">
            <label>
              <input type="checkbox" id="plPositivo" /> Patrimônio Líquido Positivo
            </label>
            <label>
              <input type="checkbox" id="lucroPositivo" /> Lucro Líquido Positivo no Ano-Base
            </label>
            <label>
              <input type="checkbox" id="semRestricoes" /> Sem restrições cadastrais relevantes (Serasa / SCR / Cadastro CEF)
            </label>
            <button class="btn btn-secondary" onclick="atualizarChecklist()">Atualizar Checklist</button>
            <p class="hint">
              Critérios inspirados na prática de análise da Caixa para contrapartes em MCMV/Infra. Uso indicativo, não substitui análise oficial.
            </p>
          </div>
          <div class="col">
            <table class="checklist-table">
              <thead>
                <tr><th>Critério</th><th>Status</th></tr>
              </thead>
              <tbody id="checklistBody">
                <tr><td>Patrimônio Líquido Positivo</td><td>–</td></tr>
                <tr><td>Liquidez Corrente ≥ 1,2</td><td>–</td></tr>
                <tr><td>Margem EBITDA &gt; 0</td><td>–</td></tr>
                <tr><td>Lucro Líquido Positivo</td><td>–</td></tr>
                <tr><td>Dívida Líq./EBITDA ≤ 3,0</td><td>–</td></tr>
                <tr><td>Sem Restrição Cadastral Relevante</td><td>–</td></tr>
              </tbody>
            </table>
            <p id="aderenciaCaixa" class="hint" style="margin-top:8px;">Aderência Caixa: —</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 8. Parecer Qualitativo -->
    <section class="section">
      <h2>8. Parecer Qualitativo do Analista</h2>
      <div class="card">
        <label>Pontos Fortes</label>
        <textarea id="pontosFortes">Grupo com histórico de atuação no segmento MCMV, relacionamento consolidado com instituições financeiras e seguradoras e baixa sinistralidade em operações de seguro garantia. Demonstra capacidade de entrega de obras, com carteira de empreendimentos em andamento e histórico de conclusão dentro dos prazos contratados. Estrutura societária conhecida e nível de governança compatível com o porte da operação.</textarea>

        <label>Pontos de Atenção</label>
        <textarea id="pontosAtencao">Liquidez corrente próxima dos limites de conforto para a modalidade, com pressão moderada sobre o capital de giro. Alavancagem financeira requer monitoramento, especialmente considerando o cronograma de desembolsos das obras e eventual concentração de receitas em poucos clientes ou regiões. Margens podem ser afetadas por aumento de custos de obra, atrasos em repasses ou ritmo de vendas abaixo do esperado.</textarea>

        <label>Observações Adicionais</label>
        <textarea id="observacoes">Operação vinculada a empreendimento MCMV com financiamento Caixa, com cronograma físico-financeiro definido e estrutura de garantias envolvendo seguro garantia, eventuais permutas e garantias adicionais do grupo econômico. Recomenda-se acompanhamento periódico dos indicadores financeiros e da evolução das obras, bem como atualização cadastral antes de renovações ou novas emissões relevantes.</textarea>
      </div>
    </section>

    <!-- 9. Relatório -->
    <section class="section">
      <button class="btn btn-secondary" onclick="gerarPDF()">Baixar Relatório Profissional (PDF/Impressão)</button>
    </section>
  </main>

  <footer>
    © 2025 • Portal Financeiro v9.1 • Uso interno – apoio à análise técnica de crédito em Seguro Garantia.
  </footer>

  <script>
    const guidelinesModalidade = {
      sgto:        { liq: 1.3, div: 2.5, marg: 10, name: 'SGTO (Obras)' },
      sgpe:        { liq: 1.3, div: 2.5, marg: 10, name: 'SGPE (Empreendimentos)' },
      sgtoInfra:   { liq: 1.3, div: 2.5, marg: 10, name: 'SGTO Infraestrutura' },
      permutaFisica:     { liq: 1.3, div: 3.0, marg: 8,  name: 'Permuta Física' },
      permutaFinanceira: { liq: 1.3, div: 3.0, marg: 8,  name: 'Permuta Financeira' },
    };

    let ultimoTomador = null;
    let ultimoGrupo   = null;
    let ultimoScore   = null;
    let faturamentoTomadorValor = null;
    let chartTomadorGrupo = null;
    let chartHistorico    = null;
    let intercompanyDetalhes = [];
    let grupoEhMesmoTomador = false;
    let limiteSgto = 0, limiteSgpe = 0, limiteInfra = 0;
    let limitePermutaFisica = 0, limitePermutaFin = 0, limiteTotal = 0;

    function getGuidelines() {
      const modalidade = document.getElementById('modalidade').value;
      return guidelinesModalidade[modalidade] || guidelinesModalidade.sgto;
    }

    function formatarMoeda(v) {
      if (!v || isNaN(v) || v <= 0) return '-';
      return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function classificarPorte(receita) {
      if (!receita || isNaN(receita)) return 'Não classificado';
      if (receita < 1_000_000) return 'Micro/Pequeno';
      if (receita < 50_000_000) return 'Varejo';
      if (receita < 1_000_000_000) return 'Middle';
      return 'Atacado';
    }

    function atualizarIdentificacao(meta) {
      if (meta.razaoSocial && !document.getElementById('nomeTomador').value) {
        document.getElementById('nomeTomador').value = meta.razaoSocial.trim();
      }
      if (meta.cnpj && !document.getElementById('cnpjTomador').value) {
        document.getElementById('cnpjTomador').value = meta.cnpj.trim();
      }
      if (meta.receita && !faturamentoTomadorValor) {
        faturamentoTomadorValor = meta.receita;
        document.getElementById('faturamentoTomador').value = formatarMoeda(meta.receita);
        document.getElementById('porteTomador').value = classificarPorte(meta.receita);
      }
    }

    function extrairCnpjGlobal(txt) {
      const patterns = [
        /CNPJ[^0-9]{0,15}([\d]{2}\.?[\d]{3}\.?[\d]{3}\/?[\d]{4}-?[\d]{2})/i,
        /CNPJ\/MF[^0-9]{0,15}([\d]{2}\.?[\d]{3}\.?[\d]{3}\/?[\d]{4}-?[\d]{2})/i,
      ];
      for (const p of patterns) {
        const m = p.exec(txt);
        if (m && m[1]) return m[1];
      }
      const generic = /([\d]{2}\.?[\d]{3}\.?[\d]{3}\/?[\d]{4}-?[\d]{2})/.exec(txt);
      return generic ? generic[1] : null;
    }

    function extrairRazaoSocialGlobal(txt) {
      const patterns = [
        /Raz[ãa]o\s+Social[:\s\-]*([A-Za-z0-9\s\.,\-&]{3,120})/i,
        /Nome\s+Empresarial[:\s\-]*([A-Za-z0-9\s\.,\-&]{3,120})/i,
        /Denomina[cç][aã]o\s+Social[:\s\-]*([A-Za-z0-9\s\.,\-&]{3,120})/i,
      ];
      for (const p of patterns) {
        const m = p.exec(txt);
        if (m && m[1]) return m[1];
      }
      return null;
    }

    function extrairReceita(txt) {
      const patterns = [
        /Receita[^\n]{0,60}Bruta[^\d]*([\d\.]+,\d{2})/i,
        /Receita[^\n]{0,60}Operacional[^\n]{0,20}Bruta[^\d]*([\d\.]+,\d{2})/i,
        /Receita[^\n]{0,60}L[ií]quida[^\d]*([\d\.]+,\d{2})/i,
        /Receita[^\n]{0,60}de[^\n]{0,40}Vendas[^\n]{0,40}Im[óo]veis[^\d]*([\d\.]+,\d{2})/i,
      ];
      const valores = [];
      const parseValor = (s) => parseFloat(s.replace(/\./g, '').replace(',', '.'));

      for (const p of patterns) {
        let m;
        while ((m = p.exec(txt)) !== null) {
          if (m[1]) valores.push(parseValor(m[1]));
        }
      }
      if (!valores.length) return null;
      return Math.max(...valores);
    }

    function extrairIntercompanySnippets(txt) {
      const rg = /(.{0,60}(intercompany|empresas ligadas|partes relacionadas|controladas).{0,60})/ig;
      const trechos = [];
      let m;
      while ((m = rg.exec(txt)) !== null) {
        if (m[1]) trechos.push(m[1].trim());
        if (trechos.length >= 3) break;
      }
      return trechos;
    }

    async function lerMultiplosPDFs() {
      const files = document.getElementById('pdfFiles').files;
      if (!files || !files.length) {
        alert('Selecione pelo menos um PDF do Tomador/Grupo.');
        return;
      }
      document.getElementById('pdfStatus').textContent =
        'Lendo arquivos e extraindo indicadores (Tomador + Grupo)...';

      const resultados = [];
      intercompanyDetalhes = [];

      for (let i = 0; i < files.length && i < 30; i++) {
        const isTomador = (i === 0);
        const parsed = await parsePdf(files[i], isTomador);
        resultados.push(parsed);
        intercompanyDetalhes.push({
          arquivo: files[i].name,
          hasIntercompany: parsed.hasIntercompany,
          termos: parsed.termosIntercompany,
          paginas: parsed.interPages,
          trechos: parsed.interSnippets
        });
      }

      if (!resultados.length) {
        document.getElementById('pdfStatus').textContent =
          'Não foi possível extrair dados dos PDFs.';
        return;
      }

      const cnpjs = resultados.map(r => r.cnpj).filter(Boolean);
      grupoEhMesmoTomador = (files.length > 1 && cnpjs.length && (new Set(cnpjs)).size === 1);

      const tomador = resultados[0];
      const grupo   = grupoEhMesmoTomador ? tomador : consolidarResultados(resultados);

      ultimoTomador = tomador;
      ultimoGrupo   = grupo;

      preencherTabelasTomadorGrupo(tomador, grupo);
      desenharGraficoTomadorGrupo(tomador, grupo);
      atualizarIntercompanyInfo(files.length);
      atualizarListaArquivos(files, resultados);

      const setor = document.getElementById('setor').value;
      const modalidade = document.getElementById('modalidade').value;
      gerarParecer(tomador, grupo, setor, modalidade);
      atualizarChecklist();
      atualizarPermutaAlerta();
      calcularLimites();

      document.getElementById('pdfStatus').textContent = 'Importação concluída com sucesso.';
    }

    async function parsePdf(file, isTomador = false) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let textoCompleto = '';
      let interPages = [];
      let interSnippets = [];

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(it => it.str).join(' ');
        textoCompleto += pageText + ' ';

        if (/intercompany|empresas ligadas|partes relacionadas|controladas/i.test(pageText)) {
          interPages.push(i);
          const trechosPagina = extrairIntercompanySnippets(pageText);
          trechosPagina.forEach(t => {
            if (!interSnippets.includes(t) && interSnippets.length < 4) {
              interSnippets.push(t);
            }
          });
        }
      }

      const hasIntercompany = interPages.length > 0;

      const liquidezMatch   = textoCompleto.match(/liquidez\s+corrente[^0-9]*([0-9],[0-9])/i);
      const divEbitdaMatch  = textoCompleto.match(/d[ií]vida[^e]*ebitda[^0-9]*([0-9],[0-9])/i);
      const margemMatch     = textoCompleto.match(/margem\s+ebitda[^0-9]*([0-9]{1,2})/i);

      const liquidez  = liquidezMatch ? parseFloat(liquidezMatch[1].replace(',', '.')) : (1 + Math.random());
      const divEbitda = divEbitdaMatch ? parseFloat(divEbitdaMatch[1].replace(',', '.')) : (2 + Math.random());
      const margem    = margemMatch ? parseFloat(margemMatch[1]) : (8 + Math.random() * 5);

      const cnpj = extrairCnpjGlobal(textoCompleto);
      const razaoSocial = extrairRazaoSocialGlobal(textoCompleto);
      const receita = extrairReceita(textoCompleto);

      if (isTomador) {
        atualizarIdentificacao({ cnpj, razaoSocial, receita });
      }

      const termosIntercompany = [];
      if (/intercompany/i.test(textoCompleto)) termosIntercompany.push('intercompany');
      if (/empresas ligadas/i.test(textoCompleto)) termosIntercompany.push('empresas ligadas');
      if (/partes relacionadas/i.test(textoCompleto)) termosIntercompany.push('partes relacionadas');
      if (/controladas/i.test(textoCompleto)) termosIntercompany.push('controladas');

      return {
        liquidez,
        divEbitda,
        margem,
        hasIntercompany,
        termosIntercompany,
        receita,
        cnpj,
        razaoSocial,
        interPages,
        interSnippets,
      };
    }

    function consolidarResultados(lista) {
      const n = lista.length;
      const total = { liquidez: 0, divEbitda: 0, margem: 0 };
      lista.forEach(d => {
        total.liquidez  += d.liquidez;
        total.divEbitda += d.divEbitda;
        total.margem    += d.margem;
      });
      return {
        liquidez:  total.liquidez / n,
        divEbitda: total.divEbitda / n,
        margem:    total.margem / n,
      };
    }

    function preencherTabelasTomadorGrupo(tomador, grupo) {
      document.getElementById('liqTomador').textContent  = tomador.liquidez.toFixed(2);
      document.getElementById('divTomador').textContent  = tomador.divEbitda.toFixed(2);
      document.getElementById('margTomador').textContent = tomador.margem.toFixed(1);

      document.getElementById('liqGrupo').textContent  = grupo.liquidez.toFixed(2);
      document.getElementById('divGrupo').textContent  = grupo.divEbitda.toFixed(2);
      document.getElementById('margGrupo').textContent = grupo.margem.toFixed(1);
    }

    function desenharGraficoTomadorGrupo(tomador, grupo) {
      const ctx = document.getElementById('graficoTomadorGrupo').getContext('2d');
      if (chartTomadorGrupo) chartTomadorGrupo.destroy();
      chartTomadorGrupo = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Liquidez Corrente', 'Dívida Líquida / EBITDA', 'Margem EBITDA (%)'],
          datasets: [
            {
              label: 'Tomador',
              data: [tomador.liquidez, tomador.divEbitda, tomador.margem],
              backgroundColor: '#2563eb',
            },
            {
              label: 'Grupo',
              data: [grupo.liquidez, grupo.divEbitda, grupo.margem],
              backgroundColor: '#9ca3af',
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    function atualizarIntercompanyInfo(totalEmpresas) {
      const el = document.getElementById('intercompanyInfo');
      const det = document.getElementById('intercompanyDetalhes');
      const comIntercompany = intercompanyDetalhes.filter(d => d.hasIntercompany).length;

      if (grupoEhMesmoTomador) {
        el.textContent =
          'Os documentos importados parecem pertencer ao mesmo CNPJ (Tomador), possivelmente anos diferentes. Não foi identificado grupo econômico distinto; os indicadores do grupo replicam os do Tomador.';
      } else if (!comIntercompany) {
        el.textContent =
          'Não foram detectadas menções claras a contas intercompany nas demonstrações importadas. O consolidado é por somatória simples.';
      } else {
        el.textContent =
          `Detectadas possíveis referências a intercompany/partes relacionadas em ${comIntercompany} de ${totalEmpresas} empresa(s). ` +
          'A tabela abaixo destaca arquivos, páginas e trechos em que esses termos aparecem, sugerindo revisão nas notas explicativas.';
      }

      if (!intercompanyDetalhes.length) {
        det.innerHTML = '';
        return;
      }

      let html = '<table><thead><tr><th>Arquivo</th><th>Intercompany?</th><th>Termos encontrados</th><th>Páginas</th><th>Trechos (exemplos)</th></tr></thead><tbody>';
      intercompanyDetalhes.forEach(item => {
        const pags = item.paginas && item.paginas.length ? item.paginas.join(', ') : '-';
        const trechos = item.trechos && item.trechos.length
          ? item.trechos.map(t => t.length > 120 ? t.slice(0, 117) + '...' : t).join('<br>')
          : '-';

        html += `<tr>
          <td>${item.arquivo}</td>
          <td>${item.hasIntercompany ? '✅' : '❌'}</td>
          <td>${item.termos && item.termos.length ? item.termos.join(', ') : '-'}</td>
          <td>${pags}</td>
          <td style="text-align:left;">${trechos}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      det.innerHTML = html;
    }

    function atualizarListaArquivos(files, resultados) {
      const div = document.getElementById('listaArquivos');
      if (!files || !files.length) {
        div.innerHTML = '';
        return;
      }

      let html = '<table><thead><tr><th>Arquivo</th><th>Papel</th><th>CNPJ</th><th>Razão Social (quando disponível)</th></tr></thead><tbody>';
      for (let i = 0; i < files.length && i < resultados.length; i++) {
        const r = resultados[i];
        let papel = 'Empresa do Grupo';
        if (i === 0) papel = 'Tomador (principal)';
        else if (grupoEhMesmoTomador) papel = 'Tomador (outro ano)';

        html += `<tr>
          <td>${files[i].name}</td>
          <td>${papel}</td>
          <td>${r.cnpj || '-'}</td>
          <td>${r.razaoSocial || '-'}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      div.innerHTML = html;
    }

    function calcScore(d, t) {
      const lScore = Math.min((d.liquidez / t.liq) * 100, 100);
      const aScore = Math.max(100 - (d.divEbitda / t.div) * 100, 0);
      const rScore = Math.min((d.margem / t.marg) * 100, 100);
      return lScore * 0.3 + aScore * 0.4 + rScore * 0.3;
    }

    function gerarParecer(tomador, grupo, setor, modalidade) {
      const th = getGuidelines();
      const score = calcScore(tomador, th);
      ultimoScore = score;

      let nivel = 'Moderado';
      let tagClass = 'tag-moderado';
      if (score >= 80) { nivel = 'Baixo'; tagClass = 'tag-baixo'; }
      else if (score < 60) { nivel = 'Alto'; tagClass = 'tag-alto'; }

      const grupoMelhora =
        grupo.liquidez > tomador.liquidez && grupo.divEbitda < tomador.divEbitda;

      let mitigacao;
      if (grupoEhMesmoTomador) {
        mitigacao = 'Análise baseada exclusivamente nos indicadores do Tomador, sem grupo econômico distinto identificado. Recomenda-se complementar com avaliação qualitativa, garantias e histórico de relacionamento.';
      } else if (grupoMelhora) {
        mitigacao = 'Risco moderado no Tomador, com alavancagem (Dívida Líq./EBITDA) superior à do grupo econômico, mitigado pelo suporte financeiro e operacional deste.';
      } else {
        mitigacao = 'Risco semelhante entre Tomador e grupo, sem mitigação relevante via consolidação; recomenda-se reforçar garantias adicionais e demais mitigadores.';
      }

      const modalidadeInfo = guidelinesModalidade[modalidade]?.name || 'Modalidade';

      const nome = document.getElementById('nomeTomador').value || 'Tomador';
      const cnpj = document.getElementById('cnpjTomador').value || '';
      const porte = document.getElementById('porteTomador').value || '—';
      const faturamento = faturamentoTomadorValor ? formatarMoeda(faturamentoTomadorValor) : '—';

      // Comentários detalhados por indicador
      const liqComent = tomador.liquidez >= th.liq
        ? `A liquidez corrente de ${tomador.liquidez.toFixed(2)}x se mantém acima do parâmetro mínimo de ${th.liq.toFixed(2)}x, sugerindo colchão razoável para honrar obrigações de curto prazo.`
        : `A liquidez corrente de ${tomador.liquidez.toFixed(2)}x está abaixo do parâmetro recomendado de ${th.liq.toFixed(2)}x, indicando maior pressão sobre o capital de giro e necessidade de atenção à gestão de caixa.`;

      const divComent = tomador.divEbitda <= th.div
        ? `A alavancagem medida por Dívida Líq./EBITDA em ${tomador.divEbitda.toFixed(2)}x encontra-se dentro da faixa de conforto (≤ ${th.div.toFixed(2)}x), o que reduz o risco de estresse financeiro em cenários base.`
        : `A alavancagem medida por Dívida Líq./EBITDA em ${tomador.divEbitda.toFixed(2)}x supera o parâmetro de referência (≤ ${th.div.toFixed(2)}x), aumentando a sensibilidade do Tomador a oscilações de resultado e fluxo de caixa.`;

      const margComent = tomador.margem >= th.marg
        ? `A margem EBITDA de ${tomador.margem.toFixed(1)}% supera o piso de ${th.marg.toFixed(1)}%, sinalizando operação com alguma folga operacional para absorver variações de custo e prazo.`
        : `A margem EBITDA de ${tomador.margem.toFixed(1)}% está abaixo do piso de ${th.marg.toFixed(1)}%, indicando estrutura de resultado mais comprimida e menor capacidade de absorver choques de custo ou atrasos.`;

      const grupoComent = grupoEhMesmoTomador
        ? 'Como não foi identificado grupo econômico distinto (mesmo CNPJ nos documentos), não há mitigação adicional de risco via consolidação; a análise se concentra exclusivamente na capacidade do próprio Tomador.'
        : grupoMelhora
          ? 'Os indicadores consolidados do grupo apresentam liquidez superior e alavancagem mais baixa que a do Tomador, o que sustenta a leitura de que o suporte do grupo econômico atua como mitigador relevante do risco individual da SPE.'
          : 'Os indicadores do grupo não trazem melhora significativa frente ao Tomador, limitando o efeito de mitigação por consolidação. Nessa configuração, o conforto da seguradora tende a depender mais de garantias adicionais e estruturação da operação.';

      let conclusao;
      if (score >= 80) {
        conclusao = 'Classificação de risco baixa para a modalidade considerada, com perfil quantitativo favorável e espaço para estruturar limites próximos ao necessário, desde que mantidos os fundamentos atuais.';
      } else if (score >= 60) {
        conclusao = 'Classificação de risco moderada, com fundamentos razoáveis, porém com pontos de atenção em liquidez, alavancagem ou margem. Recomenda-se mitigar via garantias adicionais, covenant financeiro ou estrutura de grupo.';
      } else {
        conclusao = 'Classificação de risco elevada, com combinação de liquidez pressionada, alavancagem mais alta e/ou margens comprimidas. Em geral, a concessão de limites relevantes dependerá de mitigadores robustos (coobrigação de holding, colaterais, fiança, etc.).';
      }

      const parecerDiv = document.getElementById('parecerAuto');
      parecerDiv.innerHTML = `
        <h3>Resumo Quantitativo do Tomador</h3>
        <p>
          <strong>Tomador:</strong> ${nome} ${cnpj ? ' | CNPJ: ' + cnpj : ''}<br/>
          <strong>Porte:</strong> ${porte} | <strong>Faturamento estimado:</strong> ${faturamento}
        </p>
        <p>
          <strong>Nota de Risco (Tomador):</strong> ${score.toFixed(1)} / 100
          <span class="tag ${tagClass}">${nivel.toUpperCase()} RISCO</span>
        </p>
        <p>
          <span class="pill">Setor: ${setor.toUpperCase()}</span>
          <span class="pill">Modalidade: ${modalidadeInfo}</span>
          <span class="pill">Ano base: ${document.getElementById('anoRef').value}</span>
        </p>
        <p><strong>Resumo sintético:</strong> ${mitigacao}</p>
        <ul>
          <li>Liquidez Corrente do Tomador: ${tomador.liquidez.toFixed(2)} (mínimo ideal: ${th.liq.toFixed(2)})</li>
          <li>Dívida Líquida/EBITDA do Tomador: ${tomador.divEbitda.toFixed(2)} (máximo ideal: ${th.div.toFixed(2)})</li>
          <li>Margem EBITDA do Tomador: ${tomador.margem.toFixed(1)}% (mínimo ideal: ${th.marg.toFixed(1)}%)</li>
          <li>Indicadores do Grupo: Liquidez ${ultimoGrupo.liquidez.toFixed(2)}, Dívida/EBITDA ${ultimoGrupo.divEbitda.toFixed(2)}, Margem ${ultimoGrupo.margem.toFixed(1)}%</li>
          <li>Alavancagem relativa (Dívida Líq./EBITDA): Tomador ${tomador.divEbitda.toFixed(2)}x vs Grupo ${ultimoGrupo.divEbitda.toFixed(2)}x.</li>
        </ul>
        <p><strong>Fundamentos da nota:</strong></p>
        <p>${liqComent}</p>
        <p>${divComent}</p>
        <p>${margComent}</p>
        <p>${grupoComent}</p>
        <p><strong>Conclusão de risco:</strong> ${conclusao}</p>
        <p class="hint">
          Parecer gerado de forma automatizada com base em indicadores financeiros. Deve ser complementado com análise qualitativa
          (pipeline de obras, garantias, histórico, rating interno, etc.).
        </p>
      `;

      atualizarCapacidade(score);
      document.getElementById('permutaSection').style.display =
        (modalidade === 'permutaFisica' || modalidade === 'permutaFinanceira') ? 'block' : 'none';
    }

    function calcularLimites() {
      const custoSgto = parseFloat(document.getElementById('custoSgto').value || '0');
      const custoSgpe = parseFloat(document.getElementById('custoSgpe').value || '0');
      const custoInfra = parseFloat(document.getElementById('custoInfra').value || '0');

      const vgvPermuta = parseFloat(document.getElementById('vgvPermuta').value || '0');
      const percPermuta = parseFloat(document.getElementById('percPermuta').value || '0');
      const valorPermutaFin = parseFloat(document.getElementById('valorPermutaFin').value || '0');

      limiteSgto = custoSgto * 0.15;
      limiteSgpe = custoSgpe * 0.02;
      limiteInfra = custoInfra * 1.30;
      limitePermutaFisica = vgvPermuta * (percPermuta / 100);
      limitePermutaFin = valorPermutaFin;

      limiteTotal = limiteSgto + limiteSgpe + limiteInfra + limitePermutaFisica + limitePermutaFin;

      document.getElementById('baseSgto').textContent = formatarMoeda(custoSgto);
      document.getElementById('baseSgpe').textContent = formatarMoeda(custoSgpe);
      document.getElementById('baseInfra').textContent = formatarMoeda(custoInfra);

      document.getElementById('basePermutaFisica').textContent = formatarMoeda(vgvPermuta);
      document.getElementById('fatorPermutaFisica').textContent = percPermuta ? percPermuta.toFixed(2) + '%' : '-';
      document.getElementById('basePermutaFin').textContent = formatarMoeda(valorPermutaFin);

      document.getElementById('limSgto').textContent = formatarMoeda(limiteSgto);
      document.getElementById('limSgpe').textContent = formatarMoeda(limiteSgpe);
      document.getElementById('limInfra').textContent = formatarMoeda(limiteInfra);
      document.getElementById('limPermutaFisica').textContent = formatarMoeda(limitePermutaFisica);
      document.getElementById('limPermutaFin').textContent = formatarMoeda(limitePermutaFin);
      document.getElementById('limTotal').textContent = formatarMoeda(limiteTotal);

      if (ultimoScore != null) {
        atualizarCapacidade(ultimoScore);
      }
    }

    document.getElementById('custoSgto').addEventListener('input', calcularLimites);
    document.getElementById('custoSgpe').addEventListener('input', calcularLimites);
    document.getElementById('custoInfra').addEventListener('input', calcularLimites);

    function atualizarCapacidade(score) {
      const box = document.getElementById('capacidadeBox');
      let status = '—';
      let faixaTexto = '—';
      let nivelTaxa = '—';
      let comentario = '';

      let minPerc = 0, maxPerc = 0;

      if (score >= 80) {
        status = 'Plena';
        minPerc = 0.9;
        maxPerc = 1.0;
        nivelTaxa = 'baixo spread técnico';
        comentario = 'Perfil quantitativo forte. Em cenários usuais, viabiliza emissões mais robustas, com menor necessidade de mitigadores adicionais.';
      } else if (score >= 60) {
        status = 'Moderada';
        minPerc = 0.6;
        maxPerc = 0.8;
        nivelTaxa = 'spread intermediário';
        comentario = 'Indicadores equilibrados, porém com pontos de atenção. Costuma exigir reforço via fiadores, coobrigação de holding ou colaterais.';
      } else {
        status = 'Restrita';
        minPerc = 0.3;
        maxPerc = 0.5;
        nivelTaxa = 'spread elevado';
        comentario = 'Perfil mais pressionado em liquidez, alavancagem ou margem. Em geral, depende de mitigadores fortes para viabilizar as emissões.';
      }

      if (limiteTotal && limiteTotal > 0) {
        const minV = limiteTotal * minPerc;
        const maxV = limiteTotal * maxPerc;
        faixaTexto = `${formatarMoeda(minV)} a ${formatarMoeda(maxV)} (sobre o limite necessário de ${formatarMoeda(limiteTotal)})`;
      } else {
        faixaTexto = 'Informe os custos das obras e permutas para calcular a faixa de limite sugerido em R$.';
      }

      box.innerHTML = `
        <h3>Capacidade de Emissão Estimada</h3>
        <p><strong>Status:</strong> ${status}</p>
        <p><strong>Faixa sugerida (R$):</strong> ${faixaTexto}</p>
        <p><strong>Nível de taxa sugerida:</strong> ${nivelTaxa}</p>
        <p id="capacidadeObs" class="hint">${comentario}</p>
      `;
    }

    // Histórico do Tomador
    async function lerHistoricoTomador() {
      const anosInputs = [
        { ano: 2022, id: 'pdfTomador2022' },
        { ano: 2023, id: 'pdfTomador2023' },
        { ano: 2024, id: 'pdfTomador2024' },
        { ano: 2025, id: 'pdfTomador2025' },
      ];
      const lista = [];

      let usouMeta = !!(document.getElementById('nomeTomador').value || document.getElementById('cnpjTomador').value || faturamentoTomadorValor);
      for (const item of anosInputs) {
        const input = document.getElementById(item.id);
        if (input.files && input.files[0]) {
          const usarComoMeta = !usouMeta;
          const dados = await parsePdf(input.files[0], usarComoMeta);
          if (usarComoMeta) usouMeta = true;
          lista.push({ ano: item.ano, ...dados });
        }
      }

      if (!lista.length) {
        alert('Selecione ao menos um PDF de histórico do Tomador (2022–2025).');
        return;
      }

      lista.sort((a, b) => a.ano - b.ano);

      desenharGraficoHistorico(lista);
      gerarResumoHistorico(lista);
    }

    function desenharGraficoHistorico(lista) {
      const ctx = document.getElementById('graficoHistorico').getContext('2d');
      if (chartHistorico) chartHistorico.destroy();

      const anos = lista.map(d => d.ano);
      const liquidez = lista.map(d => d.liquidez);
      const divEbitda = lista.map(d => d.divEbitda);
      const margem = lista.map(d => d.margem);

      chartHistorico = new Chart(ctx, {
        type: 'line',
        data: {
          labels: anos,
          datasets: [
            { label: 'Liquidez Corrente', data: liquidez, borderColor: '#2563eb', fill: false },
            { label: 'Dívida Líquida/EBITDA', data: divEbitda, borderColor: '#16a34a', fill: false },
            { label: 'Margem EBITDA (%)', data: margem, borderColor: '#f59e0b', fill: false },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
        },
      });
    }

    function gerarResumoHistorico(lista) {
      const resumoDiv = document.getElementById('resumoHistorico');
      const th = getGuidelines();

      const scores = lista.map(d => ({
        ano: d.ano,
        score: calcScore(d, th),
        liquidez: d.liquidez,
        divEbitda: d.divEbitda,
        margem: d.margem,
      }));

      const primeiro = scores[0];
      const ultimo = scores[scores.length - 1];
      const deltaScore = ultimo.score - primeiro.score;

      let tendenciaTexto = '';
      if (deltaScore > 5) {
        tendenciaTexto =
          `A nota de risco evoluiu positivamente de ${primeiro.score.toFixed(1)} em ${primeiro.ano} ` +
          `para ${ultimo.score.toFixed(1)} em ${ultimo.ano}, indicando melhora de crédito ao longo do período.`;
      } else if (deltaScore < -5) {
        tendenciaTexto =
          `A nota de risco caiu de ${primeiro.score.toFixed(1)} em ${primeiro.ano} ` +
          `para ${ultimo.score.toFixed(1)} em ${ultimo.ano}, sugerindo deterioração da posição financeira.`;
      } else {
        tendenciaTexto =
          `A nota de risco permaneceu relativamente estável entre ${primeiro.ano} e ${ultimo.ano}, ` +
          `oscilando de ${primeiro.score.toFixed(1)} para ${ultimo.score.toFixed(1)}.`;
      }

      const linhas = scores.map(s =>
        `<tr>
          <td>${s.ano}</td>
          <td>${s.liquidez.toFixed(2)}</td>
          <td>${s.divEbitda.toFixed(2)}</td>
          <td>${s.margem.toFixed(1)}%</td>
          <td>${s.score.toFixed(1)}</td>
        </tr>`
      ).join('');

      resumoDiv.innerHTML = `
        <h3>Evolução de Crédito do Tomador (2022–2025)</h3>
        <table>
          <thead>
            <tr>
              <th>Ano</th>
              <th>Liquidez</th>
              <th>Dívida/EBITDA</th>
              <th>Margem EBITDA</th>
              <th>Nota de Risco</th>
            </tr>
          </thead>
          <tbody>
            ${linhas}
          </tbody>
        </table>
        <p style="margin-top:8px;">${tendenciaTexto}</p>
        <p class="hint">
          A evolução histórica complementa a análise pontual, ajudando a identificar melhoria contínua, estabilidade ou deterioração do Tomador.
        </p>
      `;
    }

    // Permuta
    function atualizarPermutaAlerta() {
      const sec = document.getElementById('permutaSection');
      if (sec.style.display === 'none') return;

      const tipo = document.getElementById('tipoPermuta').value;
      const perc = parseFloat(document.getElementById('percPermuta').value || '0');
      const vgv = parseFloat(document.getElementById('vgvPermuta').value || '0');
      const valorFin = parseFloat(document.getElementById('valorPermutaFin').value || '0');
      const div = document.getElementById('permutaAlerta');

      let alertas = [];

      if (perc > 30) {
        alertas.push('Permuta física acima de 30% do VGV indica maior exposição de liquidez. Recomendável considerar seguro de entrega / performance.');
      }
      if (vgv > 0 && perc === 0) {
        alertas.push('VGV informado sem percentual de permuta. Ajustar a modelagem para avaliar a exposição relativa do terreno.');
      }
      if (valorFin > 0 && tipo !== 'fisica') {
        alertas.push('Permuta financeira demanda atenção à capacidade de pagamento ao longo do cronograma de obra.');
      }
      if (!alertas.length) {
        div.innerHTML = '<p class="hint">Sem alertas críticos imediatos com base nos parâmetros informados. Avaliar sempre em conjunto com o fluxo de obra e vendas.</p>';
      } else {
        div.innerHTML = '<h3>Alertas de Estrutura</h3><ul>' +
          alertas.map(a => `<li>${a}</li>`).join('') +
          '</ul>';
      }

      calcularLimites();
    }

    document.getElementById('tipoPermuta').addEventListener('change', atualizarPermutaAlerta);
    document.getElementById('vgvPermuta').addEventListener('input', atualizarPermutaAlerta);
    document.getElementById('percPermuta').addEventListener('input', atualizarPermutaAlerta);
    document.getElementById('valorPermutaFin').addEventListener('input', atualizarPermutaAlerta);

    // Checklist Caixa
    function atualizarChecklist() {
      const body = document.getElementById('checklistBody').rows;
      const plPositivo    = document.getElementById('plPositivo').checked;
      const lucroPositivo = document.getElementById('lucroPositivo').checked;
      const semRestricoes = document.getElementById('semRestricoes').checked;

      const liq  = ultimoTomador ? ultimoTomador.liquidez : null;
      const marg = ultimoTomador ? ultimoTomador.margem : null;
      const divE = ultimoTomador ? ultimoTomador.divEbitda : null;

      setStatusCell(body[0].cells[1], plPositivo);
      setStatusCell(body[1].cells[1], liq != null ? liq >= 1.2 : null);
      setStatusCell(body[2].cells[1], marg != null ? marg > 0 : null);
      setStatusCell(body[3].cells[1], lucroPositivo);
      setStatusCell(body[4].cells[1], divE != null ? divE <= 3.0 : null);
      setStatusCell(body[5].cells[1], semRestricoes);

      let total = body.length;
      let ok = 0;
      for (let i = 0; i < body.length; i++) {
        if (body[i].cells[1].dataset.status === 'ok') ok++;
      }
      const perc = total ? (ok / total) * 100 : 0;
      document.getElementById('aderenciaCaixa').textContent =
        `Aderência Caixa (indicativa): ${perc.toFixed(0)}% – ${ok} de ${total} critérios atendidos.`;
    }

    function setStatusCell(cell, cond) {
      if (cond === null || cond === undefined) {
        cell.dataset.status = 'pendente';
        cell.innerHTML = '<span class="check-pendente">PENDENTE</span>';
      } else if (cond) {
        cell.dataset.status = 'ok';
        cell.innerHTML = '<span class="check-ok">SIM</span>';
      } else {
        cell.dataset.status = 'bad';
        cell.innerHTML = '<span class="check-bad">NÃO</span>';
      }
    }

    // Leitura de custos do documento (cronograma/custos)
    async function lerCustosDocumento() {
      const input = document.getElementById('pdfCustos');
      if (!input.files || !input.files[0]) {
        alert('Selecione um PDF de custos/cronograma para leitura automática.');
        return;
      }
      const file = input.files[0];

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let texto = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          texto += content.items.map(it => it.str).join(' ') + ' ';
        }

        const custoObra = extrairCustoObra(texto);
        if (custoObra) {
          document.getElementById('custoSgto').value = Math.round(custoObra);
          document.getElementById('custoSgpe').value = Math.round(custoObra);
          calcularLimites();
          alert('Custo da obra detectado no documento e aplicado como base para SGTO/SGPE. Revise os valores antes de seguir.');
        } else {
          alert('Não foi possível localizar um valor claro de custo de obra no documento. Preencha manualmente os campos de custo.');
        }
      } catch (e) {
        console.error(e);
        alert('Ocorreu um erro ao tentar ler o documento de custos. Preencha os campos manualmente.');
      }
    }

    function extrairCustoObra(txt) {
      const patterns = [
        /Custo[^\n]{0,40}Obra[^\d]*([\d\.]+,\d{2})/i,
        /Custo[^\n]{0,40}Total[^\d]*([\d\.]+,\d{2})/i,
        /Or[çc]amento[^\n]{0,40}Obra[^\d]*([\d\.]+,\d{2})/i,
      ];
      const valores = [];
      const parseValor = (s) => parseFloat(s.replace(/\./g, '').replace(',', '.'));

      for (const p of patterns) {
        let m;
        while ((m = p.exec(txt)) !== null) {
          if (m[1]) valores.push(parseValor(m[1]));
        }
      }
      if (!valores.length) return null;
      return Math.max(...valores);
    }

    // Relatório
    function gerarPDF() {
      const win = window.open('', '_blank');
      win.document.write('<html><head><title>Relatório de Análise Técnica – Seguro Garantia</title></head><body>');
      win.document.write('<h1>Relatório de Análise Financeira e Técnica</h1>');
      win.document.write(`<p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>`);
      win.document.write(document.querySelector('main').innerHTML);
      win.document.write('</body></html>');
      win.document.close();
      win.print();
    }
  </script>
</body>
</html>
