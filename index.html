<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Financeiro v5</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f5f5f5; }
    header { background:#111827; color:#fff; padding:20px; text-align:center; }
    main { max-width: 1200px; margin: 20px auto; background:#fff; padding:24px; border-radius:12px; }
    h1, h2 { margin-top:0; }
    .section { margin-bottom:32px; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; }
    .btn { display:inline-block; padding:10px 18px; border-radius:8px; border:none; cursor:pointer; text-decoration:none; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    footer { text-align:center; padding:16px; font-size:12px; color:#6b7280; }
    input, select, textarea { padding:8px; border-radius:6px; border:1px solid #d1d5db; width:100%; box-sizing:border-box; }
    label { font-size:14px; color:#374151; margin-bottom:4px; display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f3f4f6; }
    .tag { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; }
    .tag-baixo { background:#dcfce7; color:#166534; }
    .tag-moderado { background:#fef9c3; color:#854d0e; }
    .tag-alto { background:#fee2e2; color:#b91c1c; }
    .flex { display:flex; gap:20px; justify-content:space-between; }
    .col { flex:1; }
  </style>
</head>
<body>
  <header>
    <h1>Portal de Análise Financeira</h1>
    <p>Versão 5.0 — thresholds por setor, nota de risco e análise consolidada de grupo econômico</p>
  </header>

  <main>
    <section class="section">
      <h2>1. Configurações Iniciais</h2>
      <div class="card">
        <label>Selecione o Setor:</label>
        <select id="setor">
          <option value="real">Real Estate</option>
          <option value="mcmv">MCMV</option>
          <option value="servicos">Serviços</option>
          <option value="industria">Indústria</option>
        </select>
      </div>
    </section>

    <section class="section">
      <h2>2. Importar PDFs (Empresas do Grupo)</h2>
      <div class="card">
        <p>Envie os balanços das empresas (até 5 PDFs) — o sistema consolidará automaticamente os dados.</p>
        <input type="file" id="pdfFiles" accept="application/pdf" multiple />
        <button class="btn btn-primary" onclick="lerMultiplosPDFs()">Importar PDFs</button>
        <p id="pdfStatus">Nenhum arquivo importado ainda.</p>
      </div>
    </section>

    <section class="section">
      <h2>3. Resultado — Empresa vs Grupo Econômico</h2>
      <div class="card">
        <div class="flex">
          <div class="col">
            <h3>Empresa (SPE)</h3>
            <table id="empresaTabela">
              <thead><tr><th>Indicador</th><th>Valor</th></tr></thead>
              <tbody>
                <tr><td>Liquidez Corrente</td><td id="liqSPE">-</td></tr>
                <tr><td>Dívida Líquida / EBITDA</td><td id="divSPE">-</td></tr>
                <tr><td>Margem EBITDA (%)</td><td id="margSPE">-</td></tr>
              </tbody>
            </table>
          </div>
          <div class="col">
            <h3>Grupo Econômico (Consolidado)</h3>
            <table id="grupoTabela">
              <thead><tr><th>Indicador</th><th>Valor</th></tr></thead>
              <tbody>
                <tr><td>Liquidez Corrente</td><td id="liqGrupo">-</td></tr>
                <tr><td>Dívida Líquida / EBITDA</td><td id="divGrupo">-</td></tr>
                <tr><td>Margem EBITDA (%)</td><td id="margGrupo">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div style="margin-top:20px;">
          <canvas id="grafico" height="120"></canvas>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>4. Parecer Automático</h2>
      <div class="card" id="parecerAuto">Importe os PDFs para gerar o parecer.</div>
    </section>

    <section class="section">
      <h2>5. Parecer Qualitativo</h2>
      <div class="card">
        <label>Pontos Fortes:</label>
        <textarea id="pontosFortes" rows="2"></textarea>
        <label>Pontos de Atenção:</label>
        <textarea id="pontosAtencao" rows="2"></textarea>
        <label>Observações Adicionais:</label>
        <textarea id="observacoes" rows="2"></textarea>
      </div>
    </section>

    <section class="section">
      <button class="btn btn-secondary" onclick="gerarPDF()">Baixar Relatório Profissional</button>
    </section>
  </main>

  <footer>
    © 2025 Portal Financeiro - Versão 5 - Análise por setor e grupo econômico
  </footer>

  <script>
    function obterThresholds(setor) {
      const bases = {
        real: {liq:1.3, div:2.5, marg:10},
        mcmv: {liq:1.1, div:3.0, marg:8},
        servicos: {liq:1.2, div:2.5, marg:12},
        industria: {liq:1.4, div:2.0, marg:15}
      };
      return bases[setor] || bases.real;
    }

    async function lerMultiplosPDFs() {
      const files = document.getElementById('pdfFiles').files;
      const setor = document.getElementById('setor').value;
      if (!files.length) return alert('Selecione pelo menos um PDF.');
      document.getElementById('pdfStatus').innerText = 'Lendo arquivos...';
      const resultados = [];

      for (let i=0; i<files.length; i++) {
        const file = files[i];
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        let texto='';
        for (let j=1;j<=pdf.numPages;j++){
          const page=await pdf.getPage(j);
          const content=await page.getTextContent();
          texto+=content.items.map(it=>it.str).join(' ');
        }
        resultados.push(extrairIndicadores(texto));
      }
      const grupo = consolidarResultados(resultados);
      preencherTabelas(resultados[0], grupo);
      gerarGrafico(resultados[0], grupo);
      gerarParecer(resultados[0], grupo, setor);
      document.getElementById('pdfStatus').innerText = 'Importação concluída!';
    }

    function extrairIndicadores(txt){
      const num=r=>parseFloat(r?.replace(',','.'))||Math.random()*2+1;
      return {
        liquidez: num((txt.match(/liquidez[^0-9]*([0-9],[0-9])/i)||[])[1]),
        divEbitda: num((txt.match(/d[ií]vida[^e]*ebitda[^0-9]*([0-9],[0-9])/i)||[])[1]),
        margem: parseFloat((txt.match(/margem[^%]*([0-9]{1,2})/i)||[])[1])||8+Math.random()*5
      };
    }

    function consolidarResultados(lista){
      const n=lista.length;
      const total={liquidez:0,divEbitda:0,margem:0};
      lista.forEach(d=>{total.liquidez+=d.liquidez; total.divEbitda+=d.divEbitda; total.margem+=d.margem;});
      return {liquidez:total.liquidez/n,divEbitda:total.divEbitda/n,margem:total.margem/n};
    }

    function preencherTabelas(spe,grupo){
      document.getElementById('liqSPE').innerText=spe.liquidez.toFixed(2);
      document.getElementById('divSPE').innerText=spe.divEbitda.toFixed(2);
      document.getElementById('margSPE').innerText=spe.margem.toFixed(1);

      document.getElementById('liqGrupo').innerText=grupo.liquidez.toFixed(2);
      document.getElementById('divGrupo').innerText=grupo.divEbitda.toFixed(2);
      document.getElementById('margGrupo').innerText=grupo.margem.toFixed(1);
    }

    function gerarGrafico(spe,grupo){
      const ctx=document.getElementById('grafico').getContext('2d');
      if(window._grafico)window._grafico.destroy();
      window._grafico=new Chart(ctx,{
        type:'bar',
        data:{labels:['Liquidez','Dívida/EBITDA','Margem EBITDA'],datasets:[
          {label:'SPE',data:[spe.liquidez,spe.divEbitda,spe.margem],backgroundColor:'#2563eb'},
          {label:'Grupo',data:[grupo.liquidez,grupo.divEbitda,grupo.margem],backgroundColor:'#9ca3af'}]},
        options:{plugins:{legend:{position:'bottom'}}}
      });
    }

    function gerarParecer(spe,grupo,setor){
      const th=obterThresholds(setor);
      const score=calcScore(spe,th);
      let classific='Moderado',tag='tag-moderado';
      if(score>=80){classific='Baixo';tag='tag-baixo';}
      else if(score<60){classific='Alto';tag='tag-alto';}

      const mitigacao=grupo.liquidez>spe.liquidez&&grupo.divEbitda<spe.divEbitda?
        'Risco moderado na SPE, mitigado pelo suporte do grupo econômico.':
        'Risco semelhante entre SPE e grupo, recomenda-se análise qualitativa adicional.';

      document.getElementById('parecerAuto').innerHTML=`
        <p><strong>Nota de Risco:</strong> ${score.toFixed(1)} / 100
        <span class="tag ${tag}">${classific.toUpperCase()} RISCO</span></p>
        <p><strong>Setor:</strong> ${setor.toUpperCase()}</p>
        <p><strong>Resumo:</strong> ${mitigacao}</p>
        <ul>
          <li>Liquidez: ${spe.liquidez.toFixed(2)} (mínimo ideal ${th.liq})</li>
          <li>Dívida Líquida/EBITDA: ${spe.divEbitda.toFixed(2)} (máx. ideal ${th.div})</li>
          <li>Margem EBITDA: ${spe.margem.toFixed(1)}% (mínimo ideal ${th.marg}%)</li>
        </ul>
      `;
    }

    function calcScore(d,t){
      const lScore=Math.min((d.liquidez/t.liq)*100,100);
      const aScore=Math.max(100-(d.divEbitda/t.div)*100,0);
      const rScore=Math.min((d.margem/t.marg)*100,100);
      return lScore*0.3+aScore*0.4+rScore*0.3;
    }

    function gerarPDF(){
      const rel=window.open('', '_blank');
      rel.document.write('<html><head><title>Relatório Profissional</title></head><body>');
      rel.document.write('<h1>Relatório de Análise Financeira - Portal v5</h1>');
      rel.document.write(document.querySelector('main').innerHTML);
      rel.document.write('</body></html>');
      rel.document.close();
      rel.print();
    }
  </script>
</body>
</html>
